%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Make sure to set your name, legi number and url to the right git branch.
\newcommand{\hmwkAuthorName}{Giacomo Giuliari} % Your name
\newcommand{\hmwkAuthorLegi}{16-932-121} % Your name
\newcommand{\hmwkGitBranch}{16-932-121/ 1\_locally\_linear\_embedding} % Your name
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%----------------------------------------------------------------------------------------
%	PACKAGES AND OTHER DOCUMENT CONFIGURATIONS
%	Skip this
%----------------------------------------------------------------------------------------

\documentclass{article}

\usepackage{fancyhdr} % Required for custom headers
\usepackage{lastpage} % Required to determine the last page for the footer
\usepackage{extramarks} % Required for headers and footers
\usepackage{graphicx} % Required to insert images
\usepackage{lipsum} % Used for inserting dummy 'Lorem ipsum' text into the template
\usepackage{enumitem}

\usepackage{animate}

% Margins
\topmargin=-0.45in
\evensidemargin=0in
\oddsidemargin=0in
\textwidth=6.5in
\textheight=9.0in
\headsep=0.25in

\linespread{1.1} % Line spacing

% Set up the header and footer
\pagestyle{fancy}
\lhead{\hmwkAuthorName} % Top left header
\chead{\hmwkClass\ \hmwkTitle} % Top center header
\rhead{\firstxmark} % Top right header
\lfoot{\lastxmark} % Bottom left footer
\cfoot{} % Bottom center footer
\rfoot{Page\ \thepage\ of\ \pageref{LastPage}} % Bottom right footer
\renewcommand\headrulewidth{0.4pt} % Size of the header rule
\renewcommand\footrulewidth{0.4pt} % Size of the footer rule

\setlength\parindent{0pt} % Removes all indentation from paragraphs

%----------------------------------------------------------------------------------------
%	DOCUMENT STRUCTURE COMMANDS
%	Skip this
%----------------------------------------------------------------------------------------

% Header and footer for when a page split occurs within a problem environment
\newcommand{\enterProblemHeader}[1]{
\nobreak\extramarks{#1}{#1 continued on next page\ldots}\nobreak
\nobreak\extramarks{#1 (continued)}{#1 continued on next page\ldots}\nobreak
}

% Header and footer for when a page split occurs between problem environments
\newcommand{\exitProblemHeader}[1]{
\nobreak\extramarks{#1 (continued)}{#1 continued on next page\ldots}\nobreak
\nobreak\extramarks{#1}{}\nobreak
}

\setcounter{secnumdepth}{0} % Removes default section numbers
\newcounter{homeworkProblemCounter} % Creates a counter to keep track of the number of problems

\newcommand{\homeworkProblemName}{}
\newenvironment{homeworkProblem}[1][Problem \arabic{homeworkProblemCounter}]{ % Makes a new environment called homeworkProblem which takes 1 argument (custom name) but the default is "Problem #"
\stepcounter{homeworkProblemCounter} % Increase counter for number of problems
\renewcommand{\homeworkProblemName}{#1} % Assign \homeworkProblemName the name of the problem
\section{\homeworkProblemName} % Make a section in the document with the custom problem count
\enterProblemHeader{\homeworkProblemName} % Header and footer within the environment
}{
\exitProblemHeader{\homeworkProblemName} % Header and footer after the environment
}

\newcommand{\problemAnswer}[1]{ % Defines the problem answer command with the content as the only argument
\noindent\framebox[\columnwidth][c]{\begin{minipage}{0.98\columnwidth}#1\end{minipage}} % Makes the box around the problem answer and puts the content inside
}

\newcommand{\homeworkSectionName}{}
\newenvironment{homeworkSection}[1]{ % New environment for sections within homework problems, takes 1 argument - the name of the section
\renewcommand{\homeworkSectionName}{#1} % Assign \homeworkSectionName to the name of the section from the environment argument
\subsection{\homeworkSectionName} % Make a subsection with the custom name of the subsection
\enterProblemHeader{\homeworkProblemName\ [\homeworkSectionName]} % Header and footer within the environment
}{
\enterProblemHeader{\homeworkProblemName} % Header and footer after the environment
}

%----------------------------------------------------------------------------------------
%	NAME AND CLASS SECTION
%	Skip this
%----------------------------------------------------------------------------------------

\newcommand{\hmwkTitle}{Locally Linear Embedding} % Assignment title
\newcommand{\hmwkDueDate}{Monday,\ March\ 6th,\ 2017} % Due date
\newcommand{\hmwkClass}{SLT coding exercise\ \#1} % Course/class
\newcommand{\hmwkClassTime}{Mo 16:15} % Class/lecture time
\newcommand{\hmwkClassInstructor}{} % Teacher/lecturer

%----------------------------------------------------------------------------------------
%	TITLE PAGE
%	Skip this
%----------------------------------------------------------------------------------------

\title{
\vspace{2in}
\textmd{\small{\hmwkClass}}\\
\textmd{\textbf{\hmwkTitle}}\\
\small{https://gitlab.vis.ethz.ch/vwegmayr/slt-coding-exercises}\\
\normalsize\vspace{0.1in}\small{Due\ on\ \hmwkDueDate}
%\vspace{0.1in}\large{\textit{\hmwkClassInstructor\ \hmwkClassTime}}
\vspace{3in}
}

\author{
\hmwkAuthorName\\
\hmwkAuthorLegi
}

\date{ } % Insert date here if you want it to appear below your name

\begin{document}

\maketitle

%----------------------------------------------------------------------------------------
%	TABLE OF CONTENTS
%	Skip this
%----------------------------------------------------------------------------------------

%\setcounter{tocdepth}{1} % Uncomment this line if you don't want subsections listed in the ToC

\newpage
\tableofcontents
\newpage

%----------------------------------------------------------------------------------------
%	SECTIONS
%	Now you are in the right hood
%----------------------------------------------------------------------------------------

\begin{homeworkProblem}[The Model]
The model section is intended to allow you to recapitulate the essential ingredients used in \hmwkTitle. Write down the \textit{necessary} equations to specify \hmwkTitle\ and and shortly explain the variables that are involved. This section should only introduce the equations, their solution should be outlined in the implementation section.\newline
Hard limit: One page
\vspace{10pt}

\problemAnswer{ % Answer
The fundamental idea of this algorithm relies on the minimization of the two reconstruction errors, defined as:
	$$ E\left( W\right) =\sum^{N}_{i=1}\parallel x_{i}-\sum 			^{N}_{i=1}w_{ij}x_{j}\parallel ^{2} $$
	
	$$E \left( y_1 \dots y_n \right) =\sum^{N}_{i=1}\parallel y_{i}-\sum ^{N}_{i=1}w_{ij}y_{j}\parallel ^{2} $$
	
However, the explicit formulation of the error is never used in the actual implementation. \\
An important role in the algorithm is played by the matrix $C_i$ for each datapoint $x_i$:
$$ C_i = Z \cdot Z^T $$
Where $Z = N - X_i$ and $N$ is the matrix containing as columns the k-nearest-neighbors of $x_i$.\\
The weights $w$ are found by solving the linear system of equations
$$ C_i \cdot w = \mathbf{1}$$
Finally, the $y$ points in the embedding are the eigenvectors of the matrix
$$ M = (I- W)^T \cdot (I - W)$$
associated with the $k+1$ smallest eigenvalues (after dropping the eigenvector associated with eigenvalue 0).


}
\end{homeworkProblem}
\clearpage

%----------------------------------------------------------------------------------------
\begin{homeworkProblem}[The Answers]
This is the core section of your report, which contains the tasks for this exercise and your respective solutions. Make sure you present your results in an illustrative way by making use of graphics, plots, tables, etc. so that a reader can understand the results with a single glance. Check that your graphics have enough resolution or are vector graphics. Consider the use of GIFs when appropriate.\newline
Hard limit: Two pages

\begin{homeworkSection}{(a) Get the data}
For this exercise we will work with the MNIST data set. In order to learn more about it and download it, go to http://yann.lecun.com/exdb/mnist/.
\end{homeworkSection}

\begin{homeworkSection}{(b) Locally linear embedding}
Implement the LLE algorithm and apply it to the MNIST data set. Provide descriptive visualizations for 2D \& 3D embedding spaces. Is it possible to see clusters?
\end{homeworkSection}

\begin{homeworkSection}{(c) Cluster structure}
Investigate the cluster structure of the data. Can you observe block structures in the $M$ matrix (use matrix plots)? Also plot the singular values of $M$. Do you notice something?
Can you think of ways to determine the optimal embedding dimension?
\end{homeworkSection}

\begin{homeworkSection}{(d) Nearest Neighbors}
Investigate the influence of the choice of how many nearest neighbors you take into account. Additionally, try different metrics to find the nearest neighbors (we are dealing with images!).
\end{homeworkSection}

\begin{homeworkSection}{(e) Linear manifold interpolation}
Assume you pick some point in the embedding space. How can you map it back to the original (high dimensional) space? Investigate how well this works for points within and outside the manifold (does it depend on the dimensionality of the embedding space?) Try things like linearly interpolating between two embedding vectors and plot the sequence of images along that line. What happens if you do that in the original space?
\end{homeworkSection}

\vspace{10pt}
\problemAnswer{ % Answer
	
	\begin{enumerate}[label=(\alph*)]
	\item{
		The dataset was loaded from the supplied website and was then parsed to access images and labels.
		}
	\item{
		In the plots, expecially the 3D ones, the clusters are clearly visible. It seems that more numbers are "recognised" (gathered in the same cluster) better tant the others.
		}
	\item{
        No relevant box structures seem to appear in the matrix plot of M.\\
        The matrix appears to be symmetric, sparse and with higher numbers on the diagonal.\\
        By plotting the singular values in order it can be noticed that there are a few of them with a high absolute value. Since the singular values are associated with the energy of the projection on the lower-dimensional space, a way to determine the optimal embedding space would be to choose the number of dimendions of the space equal to the number singular values (in order of decreasing magnitude) that have the biggest difference in value from the others (i.e. before their value starts to decrease slowly).
        This can be regarded as an "elbow method".
        }
	\item{
        The lowest error is achieved by using 4-nearest-neighbors. For values greater than 4 the error increases, for lower values the matrices can be singular.\\
        The L1-norm (Manhattan distance) was tried instead of the usual L2. No changes in the results were noticed. More sophisticated image-related metrics were not investigated due to lack of time.
	    }
	 \item{
	 	The mapping is done by first finding the k-nearest-neighbors of the point amongst the transformed ones. Then the local weights need to be calculated and used to find the corresponding point in the higher-dimensional space by applying the same weights to the transformations of the neighbors.\\
	 	The linear interpolations in the embedding and in the original space are shown in figure.
	 	}
	\end{enumerate}
}
\end{homeworkProblem}

	\begin{figure}[h]
		\centering
		\begin{minipage}{.45\textwidth}
			\centering
			\includegraphics[width=\linewidth]{imgs/2D_2000.png}
			\caption{figure}{2D Embedding}
		\end{minipage}
		\begin{minipage}{.45\textwidth}
			\centering
			\includegraphics[width=\linewidth]{imgs/3D_1_2000.png}
			\caption{figure}{3D Embedding}
		\end{minipage}
	\end{figure}

	\begin{figure}[h]
		\centering
		\begin{minipage}{.35\textwidth}
			\centering
			\includegraphics[width=\linewidth]{imgs/mat_20_1.png}
		\end{minipage}
		\begin{minipage}{.35\textwidth}
			\centering
			\includegraphics[width=\linewidth]{imgs/mat_20_2.png}
		\end{minipage}
		\caption{figure}{Matrix plots of a subset of indices on the diagonal of the M matrix.}
	\end{figure}
	
	\begin{figure}[h]
		\centering
		\begin{minipage}{.50\textwidth}
			\centering
			\includegraphics[width=\linewidth, scale=0.2]{imgs/svd_2.png}
			\caption{figure}{All the singular values}
		\end{minipage}
		\begin{minipage}{.50\textwidth}
			\centering
			\includegraphics[width=\linewidth, scale=0.2]{imgs/svd_1.png}
			\caption{figure}{The top 7 singular values. Notice the change in the 'gradient' after the third.}
		\end{minipage}
	\end{figure}
	
	\begin{figure}[h]
	\centering
	\begin{minipage}{.09\textwidth}
		\centering
		\includegraphics[width=\linewidth, scale=0.2]{Python/interp/im_0.png}
	\end{minipage}
	\begin{minipage}{.09\textwidth}
		\centering
		\includegraphics[width=\linewidth, scale=0.2]{Python/interp/im_2.png}
	\end{minipage}
	\begin{minipage}{.09\textwidth}
		\centering
		\includegraphics[width=\linewidth, scale=0.2]{Python/interp/im_4.png}
	\end{minipage}
	\begin{minipage}{.09\textwidth}
		\centering
		\includegraphics[width=\linewidth, scale=0.2]{Python/interp/im_6.png}
	\end{minipage}
	\begin{minipage}{.09\textwidth}
		\centering
		\includegraphics[width=\linewidth, scale=0.2]{Python/interp/im_8.png}
	\end{minipage}
	\begin{minipage}{.09\textwidth}
		\centering
		\includegraphics[width=\linewidth, scale=0.2]{Python/interp/im_10.png}
	\end{minipage}
	\begin{minipage}{.09\textwidth}
		\centering
		\includegraphics[width=\linewidth, scale=0.2]{Python/interp/im_12.png}
	\end{minipage}
	\begin{minipage}{.09\textwidth}
		\centering
		\includegraphics[width=\linewidth, scale=0.2]{Python/interp/im_14.png}
	\end{minipage}
	\begin{minipage}{.09\textwidth}
		\centering
		\includegraphics[width=\linewidth, scale=0.2]{Python/interp/im_16.png}
	\end{minipage}
	\begin{minipage}{.09\textwidth}
		\centering
		\includegraphics[width=\linewidth, scale=0.2]{Python/interp/im_18.png}
	\end{minipage}
	\caption{Interpolation (linear) in the 2-dimensional embedding space, mapped to the original space.}
	\end{figure}
	
	\begin{figure}[h]
		\centering
		\begin{minipage}{.09\textwidth}
			\centering
			\includegraphics[width=\linewidth, scale=0.2]{Python/interp_orig/im_0.png}
		\end{minipage}
		\begin{minipage}{.09\textwidth}
			\centering
			\includegraphics[width=\linewidth, scale=0.2]{Python/interp_orig/im_1.png}
		\end{minipage}
		\begin{minipage}{.09\textwidth}
			\centering
			\includegraphics[width=\linewidth, scale=0.2]{Python/interp_orig/im_2.png}
		\end{minipage}
		\begin{minipage}{.09\textwidth}
			\centering
			\includegraphics[width=\linewidth, scale=0.2]{Python/interp_orig/im_3.png}
		\end{minipage}
		\begin{minipage}{.09\textwidth}
			\centering
			\includegraphics[width=\linewidth, scale=0.2]{Python/interp_orig/im_4.png}
		\end{minipage}
		\begin{minipage}{.09\textwidth}
			\centering
			\includegraphics[width=\linewidth, scale=0.2]{Python/interp_orig/im_5.png}
		\end{minipage}
		\begin{minipage}{.09\textwidth}
			\centering
			\includegraphics[width=\linewidth, scale=0.2]{Python/interp_orig/im_6.png}
		\end{minipage}
		\begin{minipage}{.09\textwidth}
			\centering
			\includegraphics[width=\linewidth, scale=0.2]{Python/interp_orig/im_7.png}
		\end{minipage}
		\begin{minipage}{.09\textwidth}
			\centering
			\includegraphics[width=\linewidth, scale=0.2]{Python/interp_orig/im_8.png}
		\end{minipage}
		\begin{minipage}{.09\textwidth}
			\centering
			\includegraphics[width=\linewidth, scale=0.2]{Python/interp_orig/im_9.png}
		\end{minipage}
		\caption{Interpolation (linear) in the original 784-dimensional space.}
	\end{figure}


\clearpage






%----------------------------------------------------------------------------------------
\begin{homeworkProblem}[The Implementation]
In the implementation section you give a concise insight to the practical aspects of this coding exercise. It mainly mentions the optimization methods used to solve the model equations. Did you encounter numerical or efficiency problems? If yes, how did you solve them?
Provide the link to your git branch of this coding exercise.\newline
Hard limit: One page

\vspace{10pt}
\problemAnswer{ % Answer
	I implemented the algorithm 3 times, one using matrix inversion, another using the linear system solution and the last one changing the way the M and C matrices were handled.\\
	The implementation problems encountered were in practice the ones listed in the paper presenting the LLE algorithm. In particular:
	
	\begin{itemize}
		\item The efficiency issue of inverting the C matrix was solved by instead finding the results of the linear system and then normalizing the weights.
		
		\item The problem with singular C matrices, i.e. no solution of the linear system, was solved by adding a term to the diagonal that is small compared to the trace.
		
		\item The possibly huge dimensions of the M matrix were handled leveraging on the fact that it is sparse and symmetric, enabling efficient storage and computation.
		
		\item To find efficiently the nearest neighbors in case the total number of datapoints is "small enough" k-d trees can be used.
	\end{itemize}

}
\end{homeworkProblem}
\clearpage

%----------------------------------------------------------------------------------------
\begin{homeworkProblem}[Your Page]
Your page gives you space to include ideas, observations and results which do not fall into the categories provided by us. You can also use it as an appendix to include things which did not have space in the other sections.\newline
No page limit.

\vspace{10pt}
\problemAnswer{ % Answer
Your Answer

\hmwkGitBranch % defined in line 5
}
\end{homeworkProblem}
\clearpage

\end{document}
